# Kickstart file automatically generated by anaconda.

install
nfs --server=192.168.0.1 --dir=/kickstart
key 3e37a9013d9c8ba9
lang zh_CN.UTF-8
keyboard us
xconfig --startxonboot
network  --device eth0 --bootproto dhcp --hostname=BJBJ-BS-EF-SV-MPF03
#network  --device eth0 --bootproto dhcp
#network --device=bond0 --noipv6 --bootproto=static --onboot=yes --host=BJBJ-BS-EF-SV-NAVIMASTER01-new --ip=192.168.2.45 --netmask=255.255.255.128 --bondslave eth0,eth1 --bondopts mode=1,miimon=100
#network --device=bond0 --noipv6 --bootproto=static --onboot=yes --host=BJBJ-BS-EF-SV-NAVIMASTER01-new --ip=192.168.2.45 --netmask=255.255.255.128 --bondslave eth0,eth1 --bondopts mode=3,miimon=100

#rootpw --iscrypted $1$gWU4mvrK$tR3oanRyB9ZOdu1dJNbnV1
rootpw --iscrypted $1$FuhDxUeL$v7j9Kaa3vRTFjQUFZhxu0.
reboot
#repo --name=<efetion> --baseurl=ftp://Efcstest:TestMy@098DL@BJBJ-BS-EF-SV-BOSSI01/Server
firewall --disabled
authconfig --enableshadow --enablemd5
selinux --disabled
timezone --utc Asia/Shanghai
services --disabled=NetworkManager,acpid,anacron,apmd,atd,auditd,autofs,avahi-daemon,avahi-dnsconfd,bluetooth,capi,conman,cpuspeed,cups,dhcpd,dhcrelay,dnsmasq,dund,firstboot,gpm,haldaemon,hidd,ip6tables,ipmi,iptables,irda,irqbalance,isdn,kdump,kudzu,lvm2-monitor,mcstrans,mdmonitor,mdmpd,messagebus,microcode_ctl,multipathd,netconsole,netplugd,nfs,nscd,ntpd,pand,psacct,puppet,rawdevices,rdisc,readahead_early,readahead_later,restorecond,rhnsd,rpcgssd,rpcidmapd,rpcsvcgssd,saslauthd,sendmail,setroubleshoot,smartd,vncserver,wdaemon,winbind,wpa_supplicant,ypbind,yum-updatesd,xinetd,xfs,lm_sensors,cmirror,ricci
services --enabled=crond,netfs,network,sshd,syslog,puppet,sysstat
bootloader --location=mbr --append="rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
clearpart --all --initlabel
part / --fstype ext3 --size=245000
part /boot --fstype ext3 --size=100
part swap --size 16000

%packages
@admin-tools
@base
@chinese-support
@cluster-storage
@clustering
@core
@development-libs
@development-tools
@editors
@gnome-desktop
@gnome-software-development
@graphical-internet
@graphics
@java
@legacy-software-development
@legacy-software-support
@sound-and-video
@system-tools
@text-internet
@x-software-development
@base-x
kexec-tools
fipscheck
device-mapper-multipath
sgpio
perl-XML-SAX
libstdc++44-devel
perl-XML-NamespaceSupport
python-imaging
gcc44-c++
gcc44-gfortran
pexpect
imake
gcc-objc
gcc-gnat
libgfortran44
gcc44
emacs
libsane-hpaio
tog-pegasus
audit
net-snmp-utils
sysstat
mesa-libGLU-devel
xorg-x11-utils
xorg-x11-server-Xnest
xorg-x11-server-Xvfb
puppet

%post 

## modify /etc/inittab
sed -i 's@3:2345:respawn:/sbin/mingetty tty3@#3:2345:respawn:/sbin/mingetty tty3@' /etc/inittab
sed -i 's@4:2345:respawn:/sbin/mingetty tty4@#4:2345:respawn:/sbin/mingetty tty4@' /etc/inittab
sed -i 's@5:2345:respawn:/sbin/mingetty tty5@#5:2345:respawn:/sbin/mingetty tty5@' /etc/inittab
sed -i 's@6:2345:respawn:/sbin/mingetty tty6@#6:2345:respawn:/sbin/mingetty tty6@' /etc/inittab
sed -i 's@^id:[0-9]:initdefault@id:3:initdefault@' /etc/inittab

##add user limit
cat >> /etc/security/limits.conf <<EOF   

#start user limit...
cmcc               soft    core            2048000
cmcc               hard    core            2048000
cmcc               soft    fsize           unlimited
cmcc               hard    fsize           unlimited
cmcc               soft    data            unlimited
cmcc               hard    data            unlimited
cmcc               soft    nproc           65535
cmcc               hard    nproc           65535
cmcc               soft    stack           unlimited
cmcc               hard    stack           unlimited
cmcc               soft    nofile          409600
cmcc               hard    nofile          409600
#end user limit...
EOF

##add ip_conntrack option
cat >> /etc/sysctl.conf <<EOF

#add ip_conntrack option
#add tcp option
#add syn option
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_synack_retries = 3
net.ipv4.ip_nonlocal_bind=1
net.ipv4.conf.all.accept_redirects=0
EOF
modprobe ip_conntrack
/sbin/sysctl -p

##Add log user behavior
mkdir -p /tmp/.audit
chmod 777 /tmp/.audit

cat >> /etc/bashrc <<EOF
###########################
#Add log user behavior
export HISTTIMEFORMAT="%F %T "
shopt -s cmdhist
shopt -s histappend
echo "\$(date "+%F %T") \$(whoami) login" >> /tmp/.audit/.history-\$(date "+%F")-\$(whoami)
EOF

cat >> /root/.bash_logout <<EOF
###########################
#Add log user behavior
history >> /tmp/.audit/.history-\$(date +%F)-\$(whoami)
history -c
rm -f \$HISTFILE
echo "\$(date "+%F %T") \$(whoami) logout" >>/tmp/.audit/.history-\$(date "+%F")-\$(whoami)
EOF

cat >>/etc/skel/.bash_logout <<EOF
###########################
#Add log user behavior
history >> /tmp/.audit/.history-\$(date +%F)-\$(whoami)
history -c
rm -f \$HISTFILE
echo "\$(date "+%F %T") \$(whoami) logout" >>/tmp/.audit/.history-\$(date "+%F")-\$(whoami)
EOF

cat >/etc/cron.daily/tmpwatch <<EOF
flags=-umc
/usr/sbin/tmpwatch "\$flags" -x /tmp/.X11-unix -x /tmp/.XIM-unix \\
        -x /tmp/.font-unix -x /tmp/.ICE-unix -x /tmp/.Test-unix -x /tmp/.audit 240 /tmp
/usr/sbin/tmpwatch "\$flags" 720 /var/tmp
for d in /var/{cache/man,catman}/{cat?,X11R6/cat?,local/cat?}; do
    if [ -d "\$d" ]; then
        /usr/sbin/tmpwatch "\$flags" -f 720 "\$d"
    fi
done
EOF

##Close the unnecessary services
chkconfig --level 345 crond on
chkconfig --level 345 network on
chkconfig --level 345 ntpd on
chkconfig --level 345 sshd on
chkconfig --level 345 syslog on
chkconfig --level 345 sysstat on

chkconfig NetworkManager off
chkconfig NetworkManagerDispatcher off
chkconfig acpid off
chkconfig anacron off
chkconfig apmd off
chkconfig atd off
chkconfig auditd off
chkconfig autofs off
chkconfig avahi-daemon off
chkconfig avahi-dnsconfd off
chkconfig bluetooth off
chkconfig capi off
chkconfig conman off
chkconfig cpuspeed off
chkconfig cups off
chkconfig cmirror off
chkconfig dund off
chkconfig firstboot off
chkconfig gpm off
chkconfig haldaemon off
chkconfig hidd off
chkconfig hplip off
chkconfig httpd off
chkconfig ip6tables off
chkconfig ipmi off
chkconfig iptables off
chkconfig irda off
chkconfig irqbalance off
chkconfig isdn off
chkconfig kdump off
chkconfig kudzu off
chkconfig lm_sensors off
chkconfig mcstrans off
chkconfig mdmonitor off
chkconfig mdmpd off
chkconfig modclusterd off
chkconfig messagebus off
chkconfig microcode_ctl off
chkconfig netfs off
chkconfig netplugd off
chkconfig nfs off
chkconfig nfslock off
chkconfig nscd off
chkconfig ntpd off
chkconfig pand off
chkconfig pcscd off
chkconfig portmap off
chkconfig psacct off
chkconfig rdisc off
chkconfig readahead_early off
chkconfig readahead_later off
chkconfig restorecond off
chkconfig rhnsd off
chkconfig rpcgssd off
chkconfig rpcidmapd off
chkconfig rpcsvcgssd off
chkconfig ricci off
chkconfig rawdevices off
chkconfig saslauthd off
chkconfig sendmail off
chkconfig setroubleshoot off
chkconfig smartd off
chkconfig snmpd off
chkconfig snmptrapd off
chkconfig squid off
chkconfig tux off
chkconfig vncserver off
chkconfig winbind off
chkconfig wpa_supplicant off
chkconfig xfs off
chkconfig xinetd off
chkconfig ypbind off
chkconfig yum-updatesd off
chkconfig vsftpd off
chkconfig dhcpd off
chkconfig dhcrelay off
chkconfig lvm2-monitor off

##add user
/usr/sbin/useradd cmcc >/dev/null 2>&1
echo "cmcc7^Uh"|passwd --stdin cmcc >/dev/null 2>&1

/usr/sbin/useradd supp >/dev/null 2>&1
echo "supp8&Tf"|passwd --stdin supp >/dev/null 2>&1



#!/bin/bash

. /root/.bash_profile


if [ "`/usr/bin/id -u`" -gt "0" ];then
    echo "This command should  be executed by root"
    exit 1;
fi

##4.1.1.	±¸·Ý

BOND0_IP=172.16.4.18
BOND0_NETMASK=255.255.255.128
BOND0_GATEWAY=172.16.2.254

BOND1_IP=192.168.6.18
BOND1_NETMASK=255.255.255.128

cd /etc/sysconfig/network-scripts
mkdir bak_nobond
cp ifcfg-eth0 ./bak_nobond
cp ifcfg-eth1 ./bak_nobond
cp ifcfg-eth2 ./bak_nobond
cp ifcfg-eth3 ./bak_nobond
cp  /etc/modprobe.conf  ./bak_nobond
cp /etc/rc.d/rc.local  ./bak_nobond

##4.1.2.	ÉÖ±¾»úַ
##1.Ð½¨/etc/sysconfig/network-scripts/ifcfg-bond0Î¼þ

echo "DEVICE=bond0" >/etc/sysconfig/network-scripts/ifcfg-bond0
echo "ONBOOT=yes" >>/etc/sysconfig/network-scripts/ifcfg-bond0
echo "BOOTPROTO=none" >>/etc/sysconfig/network-scripts/ifcfg-bond0
echo "IPADDR=${BOND0_IP}" >>/etc/sysconfig/network-scripts/ifcfg-bond0
echo "NETMASK=${BOND0_NETMASK}" >>/etc/sysconfig/network-scripts/ifcfg-bond0
echo "GATEWAY=${BOND0_GATEWAY}" >>/etc/sysconfig/network-scripts/ifcfg-bond0
echo "USERCTL=no" >>/etc/sysconfig/network-scripts/ifcfg-bond0

##2.¸üc/sysconfig/network-scripts/ifcfg-eth0Í¿¨ÊÐ

echo "DEVICE=eth0" > /etc/sysconfig/network-scripts/ifcfg-eth0
echo "ONBOOT=yes" >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo "BOOTPROTO=none" >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo "MASTER=bond0" >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo "SLAVE=yes" >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo "USERCTL=no" >> /etc/sysconfig/network-scripts/ifcfg-eth0
grep HW /etc/sysconfig/network-scripts/bak_nobond/ifcfg-eth0 >> /etc/sysconfig/network-scripts/ifcfg-eth0

##3.¸üc/sysconfig/network-scripts/ifcfg-eth2Í¿¨µÄô

echo "DEVICE=eth2" > /etc/sysconfig/network-scripts/ifcfg-eth2
echo "ONBOOT=yes" >> /etc/sysconfig/network-scripts/ifcfg-eth2
echo "BOOTPROTO=none" >> /etc/sysconfig/network-scripts/ifcfg-eth2
echo "MASTER=bond0" >> /etc/sysconfig/network-scripts/ifcfg-eth2
echo "SLAVE=yes" >> /etc/sysconfig/network-scripts/ifcfg-eth2
echo "USERCTL=no" >> /etc/sysconfig/network-scripts/ifcfg-eth2
grep HW /etc/sysconfig/network-scripts/bak_nobond/ifcfg-eth2 >> /etc/sysconfig/network-scripts/ifcfg-eth2


##4.1.3.	ÉÖÐÌIPµØ·
## 1.Ð½¨/etc/sysconfig/network-scripts/ifcfg-bond1Î¼þ
echo "DEVICE=bond1" >/etc/sysconfig/network-scripts/ifcfg-bond1
echo "ONBOOT=yes" >>/etc/sysconfig/network-scripts/ifcfg-bond1
echo "BOOTPROTO=none" >>/etc/sysconfig/network-scripts/ifcfg-bond1
echo "IPADDR=${BOND1_IP}" >>/etc/sysconfig/network-scripts/ifcfg-bond1
echo "NETMASK=${BOND1_NETMASK}" >>/etc/sysconfig/network-scripts/ifcfg-bond1
echo "USERCTL=no" >>/etc/sysconfig/network-scripts/ifcfg-bond1

##2.¸üc/sysconfig/network-scripts/ifcfg-eth1Í¿¨ÊÐ
echo "DEVICE=eth1" >/etc/sysconfig/network-scripts/ifcfg-eth1
echo "ONBOOT=yes" >>/etc/sysconfig/network-scripts/ifcfg-eth1
echo "BOOTPROTO=none" >>/etc/sysconfig/network-scripts/ifcfg-eth1
echo "MASTER=bond1" >>/etc/sysconfig/network-scripts/ifcfg-eth1
echo "SLAVE=yes" >> /etc/sysconfig/network-scripts/ifcfg-eth1
echo "USERCTL=no" >>/etc/sysconfig/network-scripts/ifcfg-eth1
grep HW /etc/sysconfig/network-scripts/bak_nobond/ifcfg-eth1 >> /etc/sysconfig/network-scripts/ifcfg-eth1

##3.¸üc/sysconfig/network-scripts/ifcfg-eth3Í¿¨µÄô

echo "DEVICE=eth3" >/etc/sysconfig/network-scripts/ifcfg-eth3
echo "ONBOOT=yes" >>/etc/sysconfig/network-scripts/ifcfg-eth3
echo "BOOTPROTO=none" >>/etc/sysconfig/network-scripts/ifcfg-eth3
echo "MASTER=bond1" >>/etc/sysconfig/network-scripts/ifcfg-eth3
echo "SLAVE=yes" >> /etc/sysconfig/network-scripts/ifcfg-eth3
echo "USERCTL=no" >>/etc/sysconfig/network-scripts/ifcfg-eth3
grep HW /etc/sysconfig/network-scripts/bak_nobond/ifcfg-eth3 >> /etc/sysconfig/network-scripts/ifcfg-eth3

cat >> /etc/modprobe.conf << EOF
install bond0 /sbin/modprobe -a eth3 eth2 && /sbin/modprobe bonding
alias bond0 bonding
install bond1 /sbin/modprobe -a eth1 eth0 && /sbin/modprobe bonding
alias bond1 bonding
options bonding mode=1 miimon=100 max_bonds=2
EOF

##3.¼Óëtc/rc.d/rc.localÆ¶¯Ï

echo "/sbin/ifenslave bond1 eth3 eth1" >>  /etc/rc.d/rc.local
echo "/sbin/ifenslave bond0 eth2 eth0" >>  /etc/rc.d/rc.local

cat >> /etc/rc.local << EOF
route add -net 10.0.0.0 netmask 255.0.0.0 gw 192.168.6.126
route add -net 192.168.0.0 netmask 255.255.0.0 gw 192.168.6.126
EOF

#!/bin/bash
/bin/sed -i '/PUPPET_SERVER=puppet/c\PUPPET_SERVER=BJBJ-BS-EF-SV-BOSSI01' /etc/sysconfig/puppet
/bin/sed -i '$a\runinterval=3600' /etc/sysconfig/puppet
/bin/echo "192.168.6.3 BJBJ-BS-EF-SV-BOSSI01" >> /etc/hosts
